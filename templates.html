<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Prompt Builder - Templates</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f4f9; color: #333; }
        .container { width: 100%; max-width: 600px; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; text-align: center; }
        #template-list { list-style: none; padding: 0; margin: 20px 0; max-height: 50vh; overflow-y: auto; }
        .template-item { display: flex; align-items: center; padding: 15px; border-radius: 8px; margin-bottom: 10px; background-color: #f8f9fa; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; }
        .template-item:hover { background-color: #e9ecef; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* New and updated styles for template info and date */
        .template-info { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .template-name { font-size: 18px; user-select: none; font-weight: 500; }
        .template-date { font-size: 12px; color: #6c757d; margin-top: 4px; user-select: none; }

        .template-actions { flex-shrink: 0; display: flex; align-items: center; }
        .template-actions button { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px 8px; border-radius: 5px; margin-left: 8px; transition: background-color 0.2s, color 0.2s; }
        .template-actions .rename-btn:hover { background-color: #ffc107; color: white; }
        .template-actions .delete-btn:hover { background-color: #dc3545; color: white; }
        #new-template-btn { display: block; width: 100%; padding: 15px; font-size: 18px; border-radius: 8px; border: none; cursor: pointer; background-color: #007bff; color: white; margin-top: 20px; transition: background-color 0.2s; }
        #new-template-btn:hover { background-color: #0056b3; }
        .form-view { display: none; margin-top: 20px; }
        .form-view input { width: calc(100% - 24px); padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; }
        .form-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        .form-buttons button { padding: 10px 20px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; transition: background-color 0.2s; }
        .save-btn { background-color: #28a745; color: white; }
        .cancel-btn { background-color: #6c757d; color: white; }
        .save-btn:hover { background-color: #218838; }
        .cancel-btn:hover { background-color: #5a6268; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        .modal-content p {
            margin: 0 0 20px 0;
            font-size: 18px;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .modal-buttons button {
            padding: 10px 25px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #confirm-yes-btn {
            background-color: #dc3545;
            color: white;
        }
        #confirm-yes-btn:hover {
            background-color: #c82333;
        }
        #confirm-no-btn {
            background-color: #6c757d;
            color: white;
        }
        #confirm-no-btn:hover {
            background-color: #5a6268;
        }
        #version-display {
            position: fixed;
            bottom: 10px;
            right: 15px;
            font-size: 18px;
            color: #888;
            pointer-events: none;
            user-select: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="view-select">
        <h1>Select a Template</h1>
        <ul id="template-list"></ul>
        <button id="new-template-btn">New Template</button>
    </div>

    <div id="view-create" style="display: none;">
        <h1>Create New Template</h1>
        <div class="form-view" id="new-template-form">
            <input type="text" id="new-template-name" placeholder="Enter template name...">
            <div class="form-buttons">
                <button class="cancel-btn">Cancel</button>
                <button class="save-btn" id="create-btn">Create</button>
            </div>
        </div>
    </div>

    <div id="view-rename" style="display: none;">
        <h1>Rename Template</h1>
        <div class="form-view" id="rename-template-form" data-uid="">
            <input type="text" id="rename-template-name" placeholder="Enter new name...">
            <div class="form-buttons">
                <button class="cancel-btn">Cancel</button>
                <button class="save-btn" id="rename-save-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<div id="version-display"></div>

<div id="confirm-dialog" class="modal-overlay">
    <div class="modal-content">
        <p id="confirm-message"></p>
        <div class="modal-buttons">
            <button id="confirm-no-btn">No</button>
            <button id="confirm-yes-btn">Yes</button>
        </div>
    </div>
</div>

<script>
    const views = {
        select: document.getElementById('view-select'),
        create: document.getElementById('view-create'),
        rename: document.getElementById('view-rename')
    };
    const newTemplateForm = document.getElementById('new-template-form');
    const renameTemplateForm = document.getElementById('rename-template-form');
    const templateList = document.getElementById('template-list');

    const confirmDialog = document.getElementById('confirm-dialog');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmYesBtn = document.getElementById('confirm-yes-btn');
    const confirmNoBtn = document.getElementById('confirm-no-btn');
    let onConfirmCallback = null;

    function hideConfirmDialog() {
        confirmDialog.classList.remove('visible');
        onConfirmCallback = null;
    }

    function showConfirmDialog(message, callback) {
        confirmMessage.textContent = message;
        onConfirmCallback = callback;
        confirmDialog.classList.add('visible');
    }

    confirmYesBtn.addEventListener('click', () => {
        if (onConfirmCallback) {
            onConfirmCallback();
        }
        hideConfirmDialog();
    });

    confirmNoBtn.addEventListener('click', hideConfirmDialog);

    function switchView(viewName, data = {}) {
        Object.values(views).forEach(v => v.style.display = 'none');
        views[viewName].style.display = 'block';

        if (viewName === 'create') {
            const input = document.getElementById('new-template-name');
            input.value = '';
            input.focus();
            newTemplateForm.style.display = 'block';
        } else if (viewName === 'rename') {
            const input = document.getElementById('rename-template-name');
            input.value = data.name || '';
            renameTemplateForm.dataset.uid = data.uid || '';
            renameTemplateForm.style.display = 'block';
            input.focus();
        }
    }

    async function renderTemplates() {
        const templates = await window.electronAPI.getTemplates();
        templateList.innerHTML = '';
        
        // Sort templates by modification date (newest first)
        templates.sort((a, b) => new Date(b.mtime) - new Date(a.mtime));

        if (templates.length === 0) {
            templateList.innerHTML = '<p style="text-align: center; color: #6c757d;">No templates found. Create one to get started!</p>';
        } else {
            templates.forEach(template => {
                const li = document.createElement('li');
                li.className = 'template-item';
                li.dataset.uid = template.uid;

                li.addEventListener('click', () => {
                    window.electronAPI.loadTemplate(template.uid);
                });

                // Container for Name and Date
                const infoDiv = document.createElement('div');
                infoDiv.className = 'template-info';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'template-name';
                nameSpan.textContent = template.name;

                const dateSpan = document.createElement('span');
                dateSpan.className = 'template-date';
                const dateObj = new Date(template.mtime);
                // Format date nicely (e.g., "10/24/2023, 2:30 PM")
                dateSpan.textContent = `Last modified: ${dateObj.toLocaleString()}`;

                infoDiv.appendChild(nameSpan);
                infoDiv.appendChild(dateSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'template-actions';

                const renameBtn = document.createElement('button');
                renameBtn.className = 'rename-btn';
                renameBtn.title = 'Rename';
                renameBtn.innerHTML = '&#9998;';
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    switchView('rename', { uid: template.uid, name: template.name });
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.title = 'Delete';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirmDialog(`Are you sure you want to delete "${template.name}"?`, async () => {
                        await window.electronAPI.deleteTemplate(template.uid);
                        renderTemplates();
                    });
                });

                actionsDiv.appendChild(renameBtn);
                actionsDiv.appendChild(deleteBtn);
                li.appendChild(infoDiv); // Append info container instead of just nameSpan
                li.appendChild(actionsDiv);
                templateList.appendChild(li);
            });
        }
    }

    document.getElementById('new-template-btn').addEventListener('click', () => {
        switchView('create');
    });

    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', () => switchView('select'));
    });

    document.getElementById('create-btn').addEventListener('click', async () => {
        const nameInput = document.getElementById('new-template-name');
        const name = nameInput.value.trim();
        if (name) {
            const newTemplate = await window.electronAPI.createTemplate(name);
            if (newTemplate) {
                window.electronAPI.loadTemplate(newTemplate.uid);
            }
        }
    });

    document.getElementById('rename-save-btn').addEventListener('click', async () => {
        const nameInput = document.getElementById('rename-template-name');
        const newName = nameInput.value.trim();
        const uid = renameTemplateForm.dataset.uid;
        if (newName && uid) {
            await window.electronAPI.updateTemplate({ uid, newName });
            await renderTemplates();
            switchView('select');
        }
    });

    document.getElementById('new-template-name').addEventListener('keyup', (event) => {
        if (event.key === 'Enter') document.getElementById('create-btn').click();
    });

    document.getElementById('rename-template-name').addEventListener('keyup', (event) => {
        if (event.key === 'Enter') document.getElementById('rename-save-btn').click();
    });

    (async () => {
        const version = await window.electronAPI.getAppVersion();
        document.getElementById('version-display').textContent = `v${version}`;
    })();

    switchView('select');
    renderTemplates();
</script>
</body>
</html>